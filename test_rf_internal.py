#!/usr/bin/env python3
"""
–ú–∞—Å—Å–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ç—É—Ä—ã –†–§ ‚Äî 30 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.
–ì—Ä—É–ø–ø–∞ A (10): –ø–æ–¥–±–æ—Ä —Ç—É—Ä–∞ –≤–Ω—É—Ç—Ä–∏ –†–§
–ì—Ä—É–ø–ø–∞ B (10): –ø–æ–¥–±–æ—Ä –æ—Ç–µ–ª—è –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (—Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è)
–ì—Ä—É–ø–ø–∞ C (10): –ø–æ–¥–±–æ—Ä –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞
–ö–∞–∂–¥—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –∫–∞—Å–∫–∞–¥ –¥–æ –∫–∞—Ä—Ç–æ—á–µ–∫ + –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è (–æ—Ç–µ–ª—å/–ø–µ—Ä–µ–ª—ë—Ç/—É—Å–ª—É–≥–∏/–≤–Ω–µ-API).
–ü—Ä–æ–≤–µ—Ä—è–µ–º: —Ç–æ—á–Ω–æ—Å—Ç—å, –ª–æ–∂–Ω—ã–µ –æ–±–µ—â–∞–Ω–∏—è, –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–æ–≤, –Ω–æ–º–µ—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
"""
import requests, time, json, uuid, sys, re

BASE = "http://localhost:8080/api/v1/chat"

FALSE_PROMISE_PATTERNS = [
    "–º–æ–≥—É —É—Ç–æ—á–Ω–∏—Ç—å", "—É—Ç–æ—á–Ω—é", "—Å–≤—è–∂—É—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º", "–∑–∞–ø—Ä–æ—à—É —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞",
    "–ø–µ—Ä–µ–≤–µ–¥—É –º–µ–Ω–µ–¥–∂–µ—Ä—É", "–º–æ–≥—É —Å–≤—è–∑–∞—Ç—å—Å—è", "–æ–±—Ä–∞—â—É—Å—å –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É",
    "—É—Ç–æ—á–Ω–∏—Ç—å –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏", "–º–æ–≥—É —É—Ç–æ—á–Ω–∏—Ç—å —ç—Ç–æ", "—É—Ç–æ—á–Ω–∏—Ç—å —ç—Ç–æ —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞",
    "—É–∑–Ω–∞—é —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞", "—Å–≤—è–∂—É –≤–∞—Å", "–ø–µ—Ä–µ–∑–≤–æ–Ω—é",
]

def chat(conv_id, msg, timeout=180):
    t0 = time.time()
    try:
        r = requests.post(BASE, json={"message": msg, "conversation_id": conv_id}, timeout=timeout)
        d = r.json()
        return {
            "reply": d.get("reply", ""),
            "cards": d.get("tour_cards", []),
            "n_cards": len(d.get("tour_cards", [])),
            "time": round(time.time() - t0, 1),
        }
    except Exception as e:
        return {"reply": f"ERROR: {e}", "cards": [], "n_cards": 0, "time": round(time.time() - t0, 1)}

def detect_question(reply):
    r = reply.lower()
    if any(w in r for w in ["—Å–∫–æ–ª—å–∫–æ –≤–∑—Ä–æ—Å–ª—ã—Ö", "—Å–æ—Å—Ç–∞–≤", "–∫—Ç–æ –µ–¥–µ—Ç", "–±—É–¥—É—Ç –ª–∏ –¥–µ—Ç–∏", "—Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫"]):
        return "travelers"
    # "no results" / alternatives ‚Äî BEFORE quality, because alternatives mention "–ø–∏—Ç–∞–Ω"/"–∑–≤–µ–∑–¥" too
    if any(w in r for w in ["–Ω–µ –Ω–∞–π–¥–µ–Ω–æ", "–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö", "—Å–º—è–≥—á–∏—Ç—å", "—Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–∞—Ç—ã",
                             "–ø–æ–Ω–∏–∑–∏—Ç—å", "—Å–Ω–∏–∑–∏—Ç—å", "–¥—Ä—É–≥–æ–π –∫—É—Ä–æ—Ä—Ç"]):
        return "no_results"
    # meal-only (bot already has stars, asks only about meal)
    if any(w in r for w in ["–ø–∏—Ç–∞–Ω", "—Ç–∏–ø –ø–∏—Ç–∞–Ω–∏—è"]) and not any(w in r for w in ["–∑–≤—ë–∑–¥", "–∑–≤–µ–∑–¥", "–∫–∞—Ç–µ–≥–æ—Ä–∏"]):
        if any(w in r for w in ["–∑–∞–≤—Ç—Ä–∞–∫", "–ø–æ–ª—É–ø–∞–Ω—Å–∏–æ–Ω", "bb", "hb"]):
            return "meal_change"
        return "meal"
    if any(w in r for w in ["–∑–≤—ë–∑–¥", "–∑–≤–µ–∑–¥", "–ø–∏—Ç–∞–Ω", "–∫–∞—Ç–µ–≥–æ—Ä–∏", "–∫–ª–∞—Å—Å –æ—Ç–µ–ª"]):
        return "quality"
    if any(w in r for w in ["–≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞", "–∏–∑ –∫–∞–∫–æ–≥–æ –≥–æ—Ä–æ–¥–∞", "–æ—Ç–∫—É–¥–∞ –≤—ã–ª–µ—Ç", "–æ—Ç–∫—É–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ"]):
        return "departure"
    # month part clarification ‚Äî BEFORE generic dates
    if any(w in r for w in ["–ø—Ä–æ–º–µ–∂—É—Ç", "—á–∞—Å—Ç—å —è–Ω–≤–∞—Ä—è", "—á–∞—Å—Ç—å —Ñ–µ–≤—Ä–∞–ª—è", "—á–∞—Å—Ç—å –º–∞—Ä—Ç–∞",
                             "—á–∞—Å—Ç—å –∞–ø—Ä–µ–ª—è", "—á–∞—Å—Ç—å –º–∞—è", "—á–∞—Å—Ç—å –∏—é–Ω—è", "—á–∞—Å—Ç—å –∏—é–ª—è",
                             "—á–∞—Å—Ç—å –∞–≤–≥—É—Å—Ç–∞", "—á–∞—Å—Ç—å —Å–µ–Ω—Ç—è–±—Ä—è", "—á–∞—Å—Ç—å –æ–∫—Ç—è–±—Ä—è",
                             "—á–∞—Å—Ç—å –Ω–æ—è–±—Ä—è", "—á–∞—Å—Ç—å –¥–µ–∫–∞–±—Ä—è", "—á–∞—Å—Ç–∏ —è–Ω–≤–∞—Ä", "—á–∞—Å—Ç–∏ —Ñ–µ–≤—Ä–∞–ª",
                             "—á–∞—Å—Ç–∏ –º–∞—Ä—Ç", "—á–∞—Å—Ç–∏ –∞–ø—Ä–µ–ª", "—á–∞—Å—Ç–∏ –º–∞", "—á–∞—Å—Ç–∏ –∏—é–Ω",
                             "—á–∞—Å—Ç–∏ –∏—é–ª", "—á–∞—Å—Ç–∏ –∞–≤–≥—É—Å—Ç", "—á–∞—Å—Ç–∏ —Å–µ–Ω—Ç—è–±—Ä", "—á–∞—Å—Ç–∏ –æ–∫—Ç—è–±—Ä",
                             "—á–∞—Å—Ç–∏ –Ω–æ—è–±—Ä", "—á–∞—Å—Ç–∏ –¥–µ–∫–∞–±—Ä",
                             "–Ω–∞—á–∞–ª–æ.*—Å–µ—Ä–µ–¥–∏–Ω", "–Ω–∞—á–∞–ª.*–∫–æ–Ω—Ü"]):
        return "month_part"
    if any(w in r for w in ["–∫–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ", "–∫–∞–∫–∏–µ –¥–∞—Ç—ã", "–∫–∞–∫–æ–≥–æ —á–∏—Å–ª–∞", "–≤ –∫–∞–∫–æ–º –º–µ—Å—è—Ü–µ",
                             "–∫–æ–≥–¥–∞ —Ö–æ—Ç–∏—Ç–µ", "–∫–∞–∫—É—é —á–∞—Å—Ç—å", "–≤ –∫–∞–∫–æ–π —á–∞—Å—Ç–∏"]):
        return "dates"
    if any(w in r for w in ["—Å–∫–æ–ª—å–∫–æ –Ω–æ—á–µ–π", "–ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"]):
        return "nights"
    if any(w in r for w in ["–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω", "—Å—Ç—Ä–∞–Ω—É", "–∫—É–¥–∞ —Ö–æ—Ç–∏—Ç–µ"]):
        return "destination"
    if any(w in r for w in ["–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ", "—É—Ç–æ—á–Ω–∏—Ç–µ"]):
        return "confirm"
    return "unknown"

def has_false_promise(text):
    t = text.lower()
    for p in FALSE_PROMISE_PATTERNS:
        if p in t:
            return p
    return None

def has_phone(text):
    return "+7" in text or "555-35-35" in text

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ì–†–£–ü–ü–ê A: –ü–æ–¥–±–æ—Ä —Ç—É—Ä–∞ –≤–Ω—É—Ç—Ä–∏ –†–§ (10 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
GROUP_A = [
    {
        "id": "rf01", "name": "–°–æ—á–∏ –∏–∑ –ú–æ—Å–∫–≤—ã, —Å–µ–º—å—è —Å —Ä–µ–±—ë–Ω–∫–æ–º",
        "initial": "–ü—Ä–∏–≤–µ—Ç! –•–æ—Ç–∏–º –≤ –°–æ—á–∏ –∏–∑ –ú–æ—Å–∫–≤—ã, 15 –∏—é–Ω—è –Ω–∞ 7 –Ω–æ—á–µ–π, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö –∏ —Ä–µ–±—ë–Ω–æ–∫ 5 –ª–µ—Ç",
        "followups": {"quality": "4 –∑–≤–µ–∑–¥—ã, –∑–∞–≤—Ç—Ä–∞–∫–∏", "departure": "–º–æ—Å–∫–≤–∞", "travelers": "2 –≤–∑—Ä–æ—Å–ª—ã—Ö –∏ —Ä–µ–±–µ–Ω–æ–∫ 5 –ª–µ—Ç"},
        "consult": ["–µ—Å—Ç—å –ª–∏ –±–∞—Å—Å–µ–π–Ω?", "–∞ –∫–∞–∫–æ–π –ø–ª—è–∂ —É –æ—Ç–µ–ª—è?", "–≤–æ —Å–∫–æ–ª—å–∫–æ –∑–∞–µ–∑–¥?"],
    },
    {
        "id": "rf02", "name": "–ö—Ä—ã–º –∏–∑ –ü–∏—Ç–µ—Ä–∞",
        "initial": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —Ö–æ—á—É –≤ –ö—Ä—ã–º –∏–∑ –ü–∏—Ç–µ—Ä–∞ –Ω–∞ 10 –Ω–æ—á–µ–π, –Ω–∞—á–∞–ª–æ –∞–≤–≥—É—Å—Ç–∞",
        "followups": {"travelers": "–¥–≤–æ–µ –≤–∑—Ä–æ—Å–ª—ã—Ö", "quality": "3 –∑–≤–µ–∑–¥—ã, –≤—Å–µ –≤–∫–ª—é—á–µ–Ω–æ", "dates": "1 –∞–≤–≥—É—Å—Ç–∞ –Ω–∞ 10 –Ω–æ—á–µ–π"},
        "consult": ["–¥–∞–ª–µ–∫–æ –ª–∏ –¥–æ –º–æ—Ä—è?", "—á—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ —Ç—É—Ä?", "–º–æ–∂–Ω–æ –ª–∏ —Ä–∞—Å—Å—Ä–æ—á–∫—É?"],
    },
    {
        "id": "rf03", "name": "–ê–Ω–∞–ø–∞ –∏–∑ –ö–∞–∑–∞–Ω–∏, –ø–∞—Ä–∞",
        "initial": "—Ö–æ—á—É –≤ –ê–Ω–∞–ø—É –∏–∑ –ö–∞–∑–∞–Ω–∏, 20 –∏—é–ª—è –Ω–∞ –Ω–µ–¥–µ–ª—é, –¥–≤–æ–µ –≤–∑—Ä–æ—Å–ª—ã—Ö, 3 –∑–≤–µ–∑–¥—ã –ª—é–±–æ–µ –ø–∏—Ç–∞–Ω–∏–µ",
        "followups": {"departure": "–∫–∞–∑–∞–Ω—å"},
        "consult": ["—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –ø–µ—Ä–≤—ã–π –æ—Ç–µ–ª—å", "–∫–∞–∫–æ–π –ø–µ—Ä–µ–ª—ë—Ç?", "–∞ —Å–∫–æ–ª—å–∫–æ –±–∞–≥–∞–∂–∞ –º–æ–∂–Ω–æ –≤–∑—è—Ç—å?"],
    },
    {
        "id": "rf04", "name": "–ì–µ–ª–µ–Ω–¥–∂–∏–∫ –∏–∑ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–∞",
        "initial": "–ì–µ–ª–µ–Ω–¥–∂–∏–∫, –≤—ã–ª–µ—Ç –∏–∑ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–∞, 5 –∏—é–ª—è –Ω–∞ 7 –Ω–æ—á–µ–π, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö",
        "followups": {"quality": "–±–µ–∑ —Ä–∞–∑–Ω–∏—Ü—ã, –ª—é–±–æ–π", "travelers": "2 –≤–∑—Ä–æ—Å–ª—ã—Ö"},
        "consult": ["–µ—Å—Ç—å –¥–µ—Ç—Å–∫–∞—è –ø–ª–æ—â–∞–¥–∫–∞?", "–∫–∞–∫–æ–µ –ø–∏—Ç–∞–Ω–∏–µ?"],
    },
    {
        "id": "rf05", "name": "–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥ –∏–∑ –ú–æ—Å–∫–≤—ã",
        "initial": "—Ö–æ—á—É –≤ –∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥ –∏–∑ –º–æ—Å–∫–≤—ã, –≤ –∫–æ–Ω—Ü–µ –∏—é–Ω—è –Ω–∞ 5 –Ω–æ—á–µ–π, 2 –≤–∑—Ä, 4 –∑–≤–µ–∑–¥—ã –∑–∞–≤—Ç—Ä–∞–∫",
        "followups": {"dates": "25 –∏—é–Ω—è –Ω–∞ 5 –Ω–æ—á–µ–π"},
        "consult": ["–µ—Å—Ç—å –ª–∏ —Å–≤–æ–π –ø–ª—è–∂?", "–∫–∞–∫–∏–µ —ç–∫—Å–∫—É—Ä—Å–∏–∏ –µ—Å—Ç—å —Ä—è–¥–æ–º?"],
    },
    {
        "id": "rf06", "name": "–ö—Ä–∞—Å–Ω–∞—è –ü–æ–ª—è–Ω–∞ –∏–∑ –†–æ—Å—Ç–æ–≤–∞",
        "initial": "–ö—Ä–∞—Å–Ω–∞—è –ü–æ–ª—è–Ω–∞ –∏–∑ –†–æ—Å—Ç–æ–≤–∞, 10 –º–∞—Ä—Ç–∞ –Ω–∞ 5 –Ω–æ—á–µ–π, –¥–≤–æ–µ, 4 –∑–≤–µ–∑–¥—ã",
        "followups": {"quality": "4 –∑–≤–µ–∑–¥—ã, –∑–∞–≤—Ç—Ä–∞–∫", "travelers": "–¥–≤–æ–µ –≤–∑—Ä–æ—Å–ª—ã—Ö"},
        "consult": ["–µ—Å—Ç—å —Å–ø–∞?", "—á—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ —Ç—É—Ä?"],
    },
    {
        "id": "rf07", "name": "–ö–ú–í –∏–∑ –°–∞–º–∞—Ä—ã",
        "initial": "–ü—Ä–∏–≤–µ—Ç, —Ö–æ—Ç–∏–º –Ω–∞ –ö–ú–í –∏–∑ –°–∞–º–∞—Ä—ã, 20 –º–∞—è –Ω–∞ –Ω–µ–¥–µ–ª—é, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö",
        "followups": {"quality": "3-4 –∑–≤–µ–∑–¥—ã, –ø–æ–ª—É–ø–∞–Ω—Å–∏–æ–Ω"},
        "consult": ["–¥–∞–ª–µ–∫–æ –ª–∏ –¥–æ —Ü–µ–Ω—Ç—Ä–∞?", "–µ—Å—Ç—å –±–∞—Å—Å–µ–π–Ω?", "–º–æ–∂–Ω–æ –ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å —Ç—É—Ä?"],
    },
    {
        "id": "rf08", "name": "–°–æ—á–∏ –∏–∑ –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞, –±—é–¥–∂–µ—Ç–Ω—ã–π",
        "initial": "–∏—â—É –Ω–µ–¥–æ—Ä–æ–≥–æ–π —Ç—É—Ä –≤ –°–æ—á–∏ –∏–∑ –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞ –Ω–∞ –Ω–∞—á–∞–ª–æ —Å–µ–Ω—Ç—è–±—Ä—è, 7 –Ω–æ—á–µ–π, 2 –≤–∑—Ä",
        "followups": {"quality": "2-3 –∑–≤–µ–∑–¥—ã, –±–µ–∑ –ø–∏—Ç–∞–Ω–∏—è", "dates": "1 —Å–µ–Ω—Ç—è–±—Ä—è –Ω–∞ 7 –Ω–æ—á–µ–π"},
        "consult": ["–ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–µ—Ç–µ–π?", "–∫–∞–∫–æ–π –ø–µ—Ä–µ–ª—ë—Ç?"],
    },
    {
        "id": "rf09", "name": "–ö—Ä—ã–º –∏–∑ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞, –∞–≤–≥—É—Å—Ç",
        "initial": "–•–æ—Ç–∏–º –≤ –ö—Ä—ã–º –∏–∑ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞, —Å–µ—Ä–µ–¥–∏–Ω–∞ –∞–≤–≥—É—Å—Ç–∞ –Ω–∞ 10 –Ω–æ—á–µ–π, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö –∏ 2 –¥–µ—Ç–µ–π 7 –∏ 10 –ª–µ—Ç",
        "followups": {"quality": "4 –∑–≤–µ–∑–¥—ã, –≤—Å–µ –≤–∫–ª—é—á–µ–Ω–æ", "dates": "15 –∞–≤–≥—É—Å—Ç–∞ –Ω–∞ 10 –Ω–æ—á–µ–π"},
        "consult": ["–µ—Å—Ç—å –ª–∏ –¥–µ—Ç—Å–∫–∏–π –∫–ª—É–±?", "–¥–∞–ª–µ–∫–æ –¥–æ –º–æ—Ä—è?"],
    },
    {
        "id": "rf10", "name": "–ê–Ω–∞–ø–∞ –∏–∑ –£—Ñ—ã, –∏—é–Ω—å",
        "initial": "–ê–Ω–∞–ø–∞ –∏–∑ –£—Ñ—ã, 10 –∏—é–Ω—è –Ω–∞ –Ω–µ–¥–µ–ª—é, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö, –ª—é–±—ã–µ –∑–≤–µ–∑–¥—ã, –≤—Å–µ –≤–∫–ª—é—á–µ–Ω–æ",
        "followups": {},
        "consult": ["—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –ø–µ—Ä–≤—ã–π –æ—Ç–µ–ª—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ", "–Ω—É–∂–Ω–∞ –ª–∏ –≤–∏–∑–∞?"],
    },
]

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ì–†–£–ü–ü–ê B: –ü–æ–¥–±–æ—Ä –æ—Ç–µ–ª—è –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (—Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
GROUP_B = [
    {
        "id": "hotel01", "name": "Radisson –°–æ—á–∏ (–∞–Ω–≥–ª)",
        "initial": "–•–æ—á—É –≤ –æ—Ç–µ–ª—å Radisson –≤ –°–æ—á–∏, –∏–∑ –ú–æ—Å–∫–≤—ã, 10 –∏—é–ª—è –Ω–∞ 7 –Ω–æ—á–µ–π, 2 –≤–∑—Ä",
        "followups": {"quality": "–±–µ–∑ —Ä–∞–∑–Ω–∏—Ü—ã"},
        "consult": ["–∫–∞–∫–æ–π –ø–ª—è–∂?", "—á—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å?"],
    },
    {
        "id": "hotel02", "name": "–†—ç–¥–∏—Å—Å–æ–Ω –°–æ—á–∏ (—Ä—É—Å —Ç—Ä–∞–Ω—Å–ª–∏—Ç)",
        "initial": "–∏—â—É —Ä—ç–¥–∏—Å—Å–æ–Ω –≤ –°–æ—á–∏, –≤—ã–ª–µ—Ç –º–æ—Å–∫–≤–∞, 15 –∏—é–ª—è –Ω–µ–¥–µ–ª—è, –¥–≤–æ–µ",
        "followups": {"quality": "–ª—é–±–æ–µ –ø–∏—Ç–∞–Ω–∏–µ"},
        "consult": ["–µ—Å—Ç—å –±–∞—Å—Å–µ–π–Ω?"],
    },
    {
        "id": "hotel03", "name": "–ú—Ä–∏—è –Ø–ª—Ç–∞ (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞)",
        "initial": "—Ö–æ—á—É –≤ –æ—Ç–µ–ª—å –º—Ä–∏—è –≤ —è–ª—Ç–µ, –∏–∑ –º–æ—Å–∫–≤—ã, 1 –∞–≤–≥—É—Å—Ç–∞ –Ω–∞ 10 –Ω–æ—á–µ–π, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö",
        "followups": {"quality": "5 –∑–≤–µ–∑–¥, –ª—é–±–æ–µ –ø–∏—Ç–∞–Ω–∏–µ", "meal": "–ª—é–±–æ–µ –ø–∏—Ç–∞–Ω–∏–µ"},
        "consult": ["–∫–∞–∫–æ–µ –ø–∏—Ç–∞–Ω–∏–µ?", "–µ—Å—Ç—å —Å–≤–æ–π –ø–ª—è–∂?"],
    },
    {
        "id": "hotel04", "name": "Mriya Resort (–∞–Ω–≥–ª –ø–æ–ª–Ω–æ–µ)",
        "initial": "Mriya Resort Crimea, –≤—ã–ª–µ—Ç –ú–æ—Å–∫–≤–∞, –∞–≤–≥—É—Å—Ç –Ω–∞ 7 –Ω–æ—á–µ–π, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö, 5 –∑–≤–µ–∑–¥",
        "followups": {"dates": "5 –∞–≤–≥—É—Å—Ç–∞ –Ω–∞ 7 –Ω–æ—á–µ–π"},
        "consult": ["—Ä–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ", "–∫–∞–∫–æ–π –ø–µ—Ä–µ–ª—ë—Ç?"],
    },
    {
        "id": "hotel05", "name": "–°–æ—á–∏ –ü–∞—Ä–∫ –û—Ç–µ–ª—å (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞)",
        "initial": "–°–æ—á–∏ –ü–∞—Ä–∫ –û—Ç–µ–ª—å –∏–∑ –ü–∏—Ç–µ—Ä–∞, 20 –∏—é–Ω—è –Ω–∞ 5 –Ω–æ—á–µ–π, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö –∏ —Ä–µ–±–µ–Ω–æ–∫ 3 –≥–æ–¥–∞",
        "followups": {"quality": "–ª—é–±–æ–µ"},
        "consult": ["–ø–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ –¥–ª—è –¥–µ—Ç–µ–π?", "–¥–∞–ª–µ–∫–æ –¥–æ –º–æ—Ä—è?"],
    },
    {
        "id": "hotel06", "name": "–ë–∞—Ä—Ö–∞—Ç–Ω—ã–µ –°–µ–∑–æ–Ω—ã (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞)",
        "initial": "–ë–∞—Ä—Ö–∞—Ç–Ω—ã–µ —Å–µ–∑–æ–Ω—ã –≤ –°–æ—á–∏ –∏–∑ –ú–æ—Å–∫–≤—ã, –∏—é–ª—å –Ω–∞ –Ω–µ–¥–µ–ª—é, 2 –≤–∑—Ä",
        "followups": {"quality": "–±–µ–∑ —Ä–∞–∑–Ω–∏—Ü—ã", "dates": "10 –∏—é–ª—è –Ω–∞ 7 –Ω–æ—á–µ–π"},
        "consult": ["–µ—Å—Ç—å –±–∞—Å—Å–µ–π–Ω?", "–∫–∞–∫–æ–µ –ø–∏—Ç–∞–Ω–∏–µ?"],
    },
    {
        "id": "hotel07", "name": "Rosa Khutor (–ª–∞—Ç–∏–Ω–∏—Ü–∞ –∫—É—Ä–æ—Ä—Ç)",
        "initial": "—Ö–æ—á—É –Ω–∞ —Ä–æ–∑—É —Ö—É—Ç–æ—Ä –∏–∑ –º–æ—Å–∫–≤—ã, –∫–æ–Ω–µ—Ü –¥–µ–∫–∞–±—Ä—è –Ω–∞ 5 –Ω–æ—á–µ–π, –¥–≤–æ–µ –≤–∑—Ä–æ—Å–ª—ã—Ö, 4 –∑–≤–µ–∑–¥—ã",
        "followups": {"dates": "28 –¥–µ–∫–∞–±—Ä—è –Ω–∞ 5 –Ω–æ—á–µ–π"},
        "consult": ["—á—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ?"],
    },
    {
        "id": "hotel08", "name": "Rixos –ö—Ä–∞—Å–Ω–∞—è –ü–æ–ª—è–Ω–∞ (–º–∏–∫—Å –∞–Ω–≥–ª+—Ä—É—Å)",
        "initial": "Rixos –ö—Ä–∞—Å–Ω–∞—è –ü–æ–ª—è–Ω–∞, –∏–∑ –º–æ—Å–∫–≤—ã, 15 –º–∞—Ä—Ç–∞ –Ω–∞ 4 –Ω–æ—á–∏, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö",
        "followups": {"quality": "5 –∑–≤–µ–∑–¥, –≤—Å–µ –≤–∫–ª—é—á–µ–Ω–æ"},
        "consult": ["–µ—Å—Ç—å —Å–ø–∞?", "–∫–∞–∫–æ–π –ø–µ—Ä–µ–ª—ë—Ç?"],
    },
    {
        "id": "hotel09", "name": "–ñ–µ–º—á—É–∂–∏–Ω–∞ –°–æ—á–∏ (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞)",
        "initial": "–ñ–µ–º—á—É–∂–∏–Ω–∞ –≤ –°–æ—á–∏ –∏–∑ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–∞, 1 –∏—é–ª—è –Ω–∞ 7 –Ω–æ—á–µ–π, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö, –ª—é–±–æ–µ –ø–∏—Ç–∞–Ω–∏–µ",
        "followups": {},
        "consult": ["–¥–∞–ª–µ–∫–æ –ª–∏ –¥–æ –ø–ª—è–∂–∞?", "–µ—Å—Ç—å –ª–∏ –ø–∞—Ä–∫–æ–≤–∫–∞?"],
    },
    {
        "id": "hotel10", "name": "Azimut –°–æ—á–∏ (–∞–Ω–≥–ª –±—Ä–µ–Ω–¥)",
        "initial": "–æ—Ç–µ–ª—å –∞–∑–∏–º—É—Ç –≤ —Å–æ—á–∏, –∏–∑ –Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞, –∫–æ–Ω–µ—Ü –∞–≤–≥—É—Å—Ç–∞ –Ω–∞ –Ω–µ–¥–µ–ª—é, 2 –≤–∑—Ä, 3-4 –∑–≤–µ–∑–¥—ã",
        "followups": {"dates": "25 –∞–≤–≥—É—Å—Ç–∞ –Ω–∞ 7 –Ω–æ—á–µ–π"},
        "consult": ["–µ—Å—Ç—å –ª–∏ –∑–∞–≤—Ç—Ä–∞–∫?", "–ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–µ—Ç–µ–π?"],
    },
]

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ì–†–£–ü–ü–ê C: –ü–æ–¥–±–æ—Ä –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞ (departure=99)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
GROUP_C = [
    {
        "id": "noflight01", "name": "–°–æ—á–∏ –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, —Å–µ–º—å—è",
        "initial": "–∏—â—É —Ç—É—Ä –≤ –°–æ—á–∏ –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, 1 –∏—é–ª—è –Ω–∞ 10 –Ω–æ—á–µ–π, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö –∏ —Ä–µ–±—ë–Ω–æ–∫ 8 –ª–µ—Ç",
        "followups": {"quality": "3-4 –∑–≤–µ–∑–¥—ã, –∑–∞–≤—Ç—Ä–∞–∫"},
        "consult": ["–µ—Å—Ç—å –±–∞—Å—Å–µ–π–Ω?", "–¥–∞–ª–µ–∫–æ –¥–æ –ø–ª—è–∂–∞?"],
    },
    {
        "id": "noflight02", "name": "–ö—Ä—ã–º –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞",
        "initial": "–ö—Ä—ã–º –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, —Å–µ—Ä–µ–¥–∏–Ω–∞ –∏—é–ª—è –Ω–∞ –Ω–µ–¥–µ–ª—é, –¥–≤–æ–µ –≤–∑—Ä–æ—Å–ª—ã—Ö, 3 –∑–≤–µ–∑–¥—ã",
        "followups": {"quality": "–±–µ–∑ –ø–∏—Ç–∞–Ω–∏—è", "dates": "15 –∏—é–ª—è –Ω–∞ 7 –Ω–æ—á–µ–π"},
        "consult": ["–∫–∞–∫–æ–µ –ø–∏—Ç–∞–Ω–∏–µ?", "–≤–æ —Å–∫–æ–ª—å–∫–æ –∑–∞–µ–∑–¥?"],
    },
    {
        "id": "noflight03", "name": "–ê–Ω–∞–ø–∞ –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, –ø–∞–Ω—Å–∏–æ–Ω–∞—Ç",
        "initial": "—Ö–æ—á—É –≤ –∞–Ω–∞–ø—É –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, –Ω–∞ –∞–≤—Ç–æ–±—É—Å–µ, 5 –∞–≤–≥—É—Å—Ç–∞ –Ω–∞ 10 –Ω–æ—á–µ–π, 2 –≤–∑—Ä, –ª—é–±–æ–π –æ—Ç–µ–ª—å",
        "followups": {"quality": "–ª—é–±—ã–µ –∑–≤–µ–∑–¥—ã, –≤—Å–µ –≤–∫–ª—é—á–µ–Ω–æ"},
        "consult": ["—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –ø–µ—Ä–≤—ã–π –æ—Ç–µ–ª—å", "–º–æ–∂–Ω–æ –ª–∏ —Ä–∞—Å—Å—Ä–æ—á–∫—É?"],
    },
    {
        "id": "noflight04", "name": "–ì–µ–ª–µ–Ω–¥–∂–∏–∫ –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞",
        "initial": "–ì–µ–ª–µ–Ω–¥–∂–∏–∫ –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, –Ω–∞—á–∞–ª–æ –∏—é–Ω—è –Ω–∞ –Ω–µ–¥–µ–ª—é, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö",
        "followups": {"quality": "3 –∑–≤–µ–∑–¥—ã, –ø–æ–ª—É–ø–∞–Ω—Å–∏–æ–Ω", "dates": "1 –∏—é–Ω—è –Ω–∞ 7 –Ω–æ—á–µ–π"},
        "consult": ["–¥–∞–ª–µ–∫–æ –¥–æ –º–æ—Ä—è?"],
    },
    {
        "id": "noflight05", "name": "–ö–ú–í –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, –ª–µ—á–µ–Ω–∏–µ",
        "initial": "–∫–∏—Å–ª–æ–≤–æ–¥—Å–∫ –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, 10 –º–∞—è –Ω–∞ 14 –Ω–æ—á–µ–π, 1 –≤–∑—Ä–æ—Å–ª—ã–π, —Å–∞–Ω–∞—Ç–æ—Ä–∏–π",
        "followups": {"quality": "–ª—é–±–æ–π"},
        "consult": ["–µ—Å—Ç—å –ª–∏ –ª–µ—á–µ–Ω–∏–µ?", "–∫–∞–∫–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ?"],
    },
    {
        "id": "noflight06", "name": "–ê–¥–ª–µ—Ä –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, –±—é–¥–∂–µ—Ç–Ω—ã–π",
        "initial": "–∞–¥–ª–µ—Ä –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, –∫–æ–Ω–µ—Ü –º–∞—è, 5 –Ω–æ—á–µ–π, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö, –¥–æ 30000",
        "followups": {"quality": "–ª—é–±—ã–µ –∑–≤–µ–∑–¥—ã", "dates": "25 –º–∞—è –Ω–∞ 5 –Ω–æ—á–µ–π"},
        "consult": ["–µ—Å—Ç—å –ª–∏ –ø–ª—è–∂?", "—á—Ç–æ –≤—Ö–æ–¥–∏—Ç?"],
    },
    {
        "id": "noflight07", "name": "–°–æ—á–∏ –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, 5 –∑–≤—ë–∑–¥",
        "initial": "–°–æ—á–∏ –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, 20 –∏—é–Ω—è –Ω–∞ –Ω–µ–¥–µ–ª—é, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö, 5 –∑–≤—ë–∑–¥ –≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ",
        "followups": {},
        "consult": ["–µ—Å—Ç—å —Å–ø–∞?", "–∫–∞–∫–æ–π —Ä–µ–π—Ç–∏–Ω–≥ –æ—Ç–µ–ª—è?", "—É—Å–ª–æ–≤–∏—è –æ—Ç–º–µ–Ω—ã?"],
    },
    {
        "id": "noflight08", "name": "–ê–±—Ö–∞–∑–∏—è –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞",
        "initial": "–∞–±—Ö–∞–∑–∏—è –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, –∏—é–ª—å –Ω–∞ 10 –Ω–æ—á–µ–π, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö",
        "followups": {"quality": "–ª—é–±–æ–π", "dates": "10 –∏—é–ª—è –Ω–∞ 10 –Ω–æ—á–µ–π"},
        "consult": ["–µ—Å—Ç—å –±–∞—Å—Å–µ–π–Ω?", "–Ω—É–∂–Ω–∞ –ª–∏ –≤–∏–∑–∞?"],
    },
    {
        "id": "noflight09", "name": "–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥ –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞",
        "initial": "–∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥ –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞ –Ω–∞ 5 –Ω–æ—á–µ–π –≤ –Ω–∞—á–∞–ª–µ —Å–µ–Ω—Ç—è–±—Ä—è, –¥–≤–æ–µ",
        "followups": {"quality": "4 –∑–≤–µ–∑–¥—ã, –∑–∞–≤—Ç—Ä–∞–∫", "dates": "1 —Å–µ–Ω—Ç—è–±—Ä—è –Ω–∞ 5 –Ω–æ—á–µ–π", "travelers": "2 –≤–∑—Ä–æ—Å–ª—ã—Ö"},
        "consult": ["—Ä–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ –ø–µ—Ä–≤—ã–π", "—ç–∫—Å–∫—É—Ä—Å–∏–∏ —Ä—è–¥–æ–º?"],
    },
    {
        "id": "noflight10", "name": "–ö—Ä–∞—Å–Ω–∞—è –ü–æ–ª—è–Ω–∞ –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, –∑–∏–º–∞",
        "initial": "–∫—Ä–∞—Å–Ω–∞—è –ø–æ–ª—è–Ω–∞ –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞, –Ω–æ–≤—ã–π –≥–æ–¥, 5 –Ω–æ—á–µ–π, 2 –≤–∑—Ä–æ—Å–ª—ã—Ö, 4 –∑–≤–µ–∑–¥—ã",
        "followups": {"dates": "30 –¥–µ–∫–∞–±—Ä—è –Ω–∞ 5 –Ω–æ—á–µ–π"},
        "consult": ["—á—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ —Ç—É—Ä?", "–µ—Å—Ç—å –ª–∏ —Å–ø–∞?"],
    },
]

ALL_SCENARIOS = GROUP_A + GROUP_B + GROUP_C

def run_scenario(scenario):
    conv_id = f"test-rf-{scenario['id']}-{uuid.uuid4().hex[:6]}"
    log = []
    total_time = 0
    got_cards = False

    print(f"\n{'='*70}")
    print(f"  –°–¶–ï–ù–ê–†–ò–ô {scenario['id']}: {scenario['name']}")
    print(f"{'='*70}")

    # Step 1: Initial message
    r = chat(conv_id, scenario["initial"])
    total_time += r["time"]
    log.append({"role": "user", "msg": scenario["initial"]})
    log.append({"role": "bot", "msg": r["reply"], "cards": r["n_cards"], "time": r["time"]})
    print(f"  üë§ [{scenario['id']}] User: {scenario['initial'][:100]}")
    print(f"  ü§ñ [{scenario['id']}] Bot ({r['time']}s, {r['n_cards']} –∫–∞—Ä—Ç): {r['reply'][:150]}")
    if r["n_cards"] > 0:
        got_cards = True
        for c in r["cards"][:3]:
            print(f"     üé¥ {c.get('hotelName','?')} | {c.get('price','?')}‚ÇΩ")
    time.sleep(1)

    # Step 2: Follow-up cascade (max 8 rounds)
    for attempt in range(8):
        if got_cards:
            break
        q_type = detect_question(r["reply"])
        answer = scenario.get("followups", {}).get(q_type)
        # month_part ‚Üí try "dates" followup first (it has the concrete answer)
        if not answer and q_type == "month_part":
            answer = scenario.get("followups", {}).get("dates")
        if not answer:
            if q_type == "travelers":
                answer = "2 –≤–∑—Ä–æ—Å–ª—ã—Ö"
            elif q_type == "quality":
                answer = "–ª—é–±–æ–π"
            elif q_type == "departure":
                answer = "–º–æ—Å–∫–≤–∞"
            elif q_type in ("dates", "month_part"):
                answer = "–≤ —Å–µ—Ä–µ–¥–∏–Ω–µ"
            elif q_type == "meal":
                answer = "–ª—é–±–æ–µ –ø–∏—Ç–∞–Ω–∏–µ"
            elif q_type == "meal_change":
                answer = "–∑–∞–≤—Ç—Ä–∞–∫"
            elif q_type == "no_results":
                answer = "—Ä–∞—Å—à–∏—Ä—å—Ç–µ –¥–∞—Ç—ã –∏ –ø–æ–Ω–∏–∑—å—Ç–µ –∑–≤—ë–∑–¥—ã"
            elif q_type == "confirm":
                answer = "–¥–∞"
            elif q_type == "destination":
                answer = "—Ä–æ—Å—Å–∏—è, —Å–æ—á–∏"
            else:
                answer = "–¥–∞, –ø–æ–¥–±–∏—Ä–∞–π—Ç–µ"

        r = chat(conv_id, answer)
        total_time += r["time"]
        log.append({"role": "user", "msg": answer})
        log.append({"role": "bot", "msg": r["reply"], "cards": r["n_cards"], "time": r["time"]})
        print(f"  üë§ [{scenario['id']}] User: {answer}")
        print(f"  ü§ñ [{scenario['id']}] Bot ({r['time']}s, {r['n_cards']} –∫–∞—Ä—Ç): {r['reply'][:150]}")
        if r["n_cards"] > 0:
            got_cards = True
            for c in r["cards"][:3]:
                print(f"     üé¥ {c.get('hotelName','?')} | {c.get('price','?')}‚ÇΩ")
        time.sleep(1)

    # Step 3: Consultation questions
    consult_results = []
    if got_cards:
        print(f"\n  --- –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–Ø [{scenario['id']}] ---")
        for q in scenario.get("consult", []):
            prefixed_q = f"–≤ –ø–µ—Ä–≤–æ–º –æ—Ç–µ–ª–µ ‚Äî {q}" if not any(
                w in q.lower() for w in ["–ø–µ—Ä–≤—ã–π", "–ø–µ—Ä–≤–æ–º", "–ø–µ—Ä–≤–æ–≥–æ", "–ø–æ–¥—Ä–æ–±–Ω–µ–µ", "—Ä–∞—Å—Å–∫–∞–∂–∏"]
            ) else q
            r = chat(conv_id, prefixed_q)
            total_time += r["time"]

            reply_lower = r["reply"].lower()
            asks_which = any(w in reply_lower for w in [
                "–∫–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç", "–∫–∞–∫–æ–π –æ—Ç–µ–ª—å", "–∫–∞–∫–æ–≥–æ –æ—Ç–µ–ª—è", "–ø—Ä–æ –∫–∞–∫–æ–π",
                "–∫–∞–∫–æ–π –∏–∑", "–∫–∞–∫–æ–º—É –≤–∞—Ä–∏–∞–Ω—Ç—É", "–ø–æ –∫–∞–∫–æ–º—É", "—É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä",
            ])
            if asks_which:
                print(f"  üîÑ [{scenario['id']}] –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç —É—Ç–æ—á–Ω—è–µ—Ç –æ—Ç–µ–ª—å ‚Üí –æ—Ç–≤–µ—á–∞–µ–º '–ø–µ—Ä–≤—ã–π'")
                log.append({"role": "user", "msg": prefixed_q})
                log.append({"role": "bot", "msg": r["reply"], "cards": r["n_cards"], "time": r["time"]})
                r2 = chat(conv_id, "–ø–µ—Ä–≤—ã–π")
                total_time += r2["time"]
                log.append({"role": "user", "msg": "–ø–µ—Ä–≤—ã–π"})
                log.append({"role": "bot", "msg": r2["reply"], "cards": r2["n_cards"], "time": r2["time"]})
                r = r2
                time.sleep(0.5)

            fp = has_false_promise(r["reply"])
            phone = has_phone(r["reply"])
            log.append({"role": "user", "msg": prefixed_q})
            log.append({"role": "bot", "msg": r["reply"], "cards": r["n_cards"], "time": r["time"]})
            consult_results.append({
                "question": q,
                "reply": r["reply"],
                "time": r["time"],
                "len": len(r["reply"]),
                "false_promise": fp,
                "has_phone": phone,
            })
            print(f"  ‚ùì [{scenario['id']}] Q: {prefixed_q}")
            print(f"  üí¨ [{scenario['id']}] A ({r['time']}s, {len(r['reply'])}—á): {r['reply'][:200]}")
            if fp:
                print(f"  ‚ö†Ô∏è  –õ–û–ñ–ù–û–ï –û–ë–ï–©–ê–ù–ò–ï: ¬´{fp}¬ª")
            time.sleep(1)

    return {
        "id": scenario["id"],
        "name": scenario["name"],
        "got_cards": got_cards,
        "total_time": round(total_time, 1),
        "n_messages": len(log),
        "consult": consult_results,
        "log": log,
    }


def generate_report(results):
    lines = []
    lines.append("# –û—Ç—á—ë—Ç: –º–∞—Å—Å–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ç—É—Ä–æ–≤ –†–§\n")
    lines.append(f"**–î–∞—Ç–∞:** {time.strftime('%Y-%m-%d %H:%M')}")
    lines.append(f"**–°—Ü–µ–Ω–∞—Ä–∏–µ–≤:** {len(results)}\n")

    # Summary
    cards_ok = sum(1 for r in results if r["got_cards"])
    total_consult = sum(len(r["consult"]) for r in results)
    false_promises = sum(1 for r in results for c in r["consult"] if c["false_promise"])
    no_phone = sum(1 for r in results for c in r["consult"]
                   if not c["has_phone"] and any(w in c["question"].lower()
                   for w in ["–∑–∞–µ–∑–¥","—ç–∫—Å–∫—É—Ä—Å–∏","–±–∞–≥–∞–∂","—Ä–∞—Å—Å—Ä–æ—á–∫","–æ—Ç–º–µ–Ω","–ø–∞—Ä–∫–æ–≤–∫","–≤–∏–∑–∞","–º–µ–Ω–µ–¥–∂–µ—Ä"]))
    avg_times = [e["time"] for r in results for e in r["log"] if e.get("role") == "bot"]
    avg_t = round(sum(avg_times) / len(avg_times), 1) if avg_times else 0

    lines.append("## –°–≤–æ–¥–∫–∞\n")
    lines.append(f"| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |")
    lines.append(f"|---|---|")
    lines.append(f"| –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã | {cards_ok}/{len(results)} |")
    lines.append(f"| –í–æ–ø—Ä–æ—Å–æ–≤ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ | {total_consult} |")
    lines.append(f"| –õ–æ–∂–Ω—ã–µ –æ–±–µ—â–∞–Ω–∏—è | {false_promises} |")
    lines.append(f"| –í–Ω–µ-API –±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ | {no_phone} |")
    lines.append(f"| –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ | {avg_t}—Å |")
    lines.append("")

    # Group A
    lines.append("\n## –ì—Ä—É–ø–ø–∞ A: –ü–æ–¥–±–æ—Ä —Ç—É—Ä–∞ –≤–Ω—É—Ç—Ä–∏ –†–§\n")
    for r in results[:10]:
        _report_scenario(lines, r)

    # Group B
    lines.append("\n## –ì—Ä—É–ø–ø–∞ B: –ü–æ–¥–±–æ—Ä –æ—Ç–µ–ª—è –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é\n")
    for r in results[10:20]:
        _report_scenario(lines, r)

    # Group C
    lines.append("\n## –ì—Ä—É–ø–ø–∞ C: –ë–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞\n")
    for r in results[20:30]:
        _report_scenario(lines, r)

    # Errors section
    errors = []
    for r in results:
        if not r["got_cards"]:
            errors.append(f"**{r['id']}** ({r['name']}): –∫–∞—Ä—Ç–æ—á–∫–∏ –ù–ï –ø–æ–ª—É—á–µ–Ω—ã")
        for c in r["consult"]:
            if c["false_promise"]:
                errors.append(f"**{r['id']}** ‚Äî ¬´{c['question']}¬ª: –ª–æ–∂–Ω–æ–µ –æ–±–µ—â–∞–Ω–∏–µ ¬´{c['false_promise']}¬ª")
            if not c["has_phone"] and any(w in c["question"].lower()
                for w in ["–∑–∞–µ–∑–¥","—ç–∫—Å–∫—É—Ä—Å–∏","–±–∞–≥–∞–∂","—Ä–∞—Å—Å—Ä–æ—á–∫","–æ—Ç–º–µ–Ω","–ø–∞—Ä–∫–æ–≤–∫"]):
                errors.append(f"**{r['id']}** ‚Äî ¬´{c['question']}¬ª: –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞")
        for e in r["log"]:
            if e.get("role") == "bot" and "–æ—à–∏–±–∫–∞" in e.get("msg","").lower() and "–≤—Ä–µ–º–µ–Ω–Ω–∞—è" not in e.get("msg","").lower():
                errors.append(f"**{r['id']}**: –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç ¬´–æ—à–∏–±–∫–∞¬ª ‚Äî {e['msg'][:100]}")

    lines.append("\n## –ù–∞–π–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏\n")
    if errors:
        for e in errors:
            lines.append(f"- {e}")
    else:
        lines.append("–û—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.")

    # Timing
    lines.append("\n## –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–æ–≤ (—Å—Ä–µ–¥–Ω–∏–µ)\n")
    lines.append("| –ì—Ä—É–ø–ø–∞ | –°—Ä–µ–¥–Ω–µ–µ | –ú–∞–∫—Å |")
    lines.append("|---|---|---|")
    for gname, gslice in [("A: –¢—É—Ä—ã –†–§", results[:10]), ("B: –ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é", results[10:20]), ("C: –ë–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞", results[20:30])]:
        times = [e["time"] for r in gslice for e in r["log"] if e.get("role") == "bot"]
        if times:
            lines.append(f"| {gname} | {round(sum(times)/len(times),1)}—Å | {max(times)}—Å |")

    return "\n".join(lines)


def _report_scenario(lines, r):
    status = "‚úÖ" if r["got_cards"] else "‚ùå"
    lines.append(f"### {r['id']}: {r['name']} {status}\n")
    lines.append(f"–ö–∞—Ä—Ç–æ—á–∫–∏: {'–î–∞' if r['got_cards'] else '–ù–ï–¢'} | –í—Ä–µ–º—è: {r['total_time']}—Å | –°–æ–æ–±—â–µ–Ω–∏–π: {r['n_messages']}\n")

    if r["consult"]:
        lines.append("| –í–æ–ø—Ä–æ—Å | –í—Ä–µ–º—è | –î–ª–∏–Ω–∞ | –õ–æ–∂. –æ–±–µ—â–∞–Ω–∏–µ | –¢–µ–ª–µ—Ñ–æ–Ω | –û—Ç–≤–µ—Ç |")
        lines.append("|---|---|---|---|---|---|")
        for c in r["consult"]:
            fp = f"‚ö†Ô∏è {c['false_promise']}" if c["false_promise"] else "–ù–µ—Ç"
            ph = "–î–∞" if c["has_phone"] else "‚Äî"
            short = c["reply"][:200].replace("|","\\|").replace("\n"," ")
            lines.append(f"| {c['question']} | {c['time']}—Å | {c['len']} | {fp} | {ph} | {short} |")
    lines.append("")


if __name__ == "__main__":
    print(f"\n{'#'*70}")
    print(f"# –ú–ê–°–°–û–í–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï: –í–ù–£–¢–†–ï–ù–ù–ò–ï –¢–£–†–´ –†–§ ‚Äî 30 –°–¶–ï–ù–ê–†–ò–ï–í")
    print(f"# {time.strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"{'#'*70}\n")

    results = []
    for i, sc in enumerate(ALL_SCENARIOS):
        print(f"\n[{i+1}/{len(ALL_SCENARIOS)}]", flush=True)
        result = run_scenario(sc)
        results.append(result)
        time.sleep(2)

    report = generate_report(results)
    with open("TEST_RF_INTERNAL_REPORT.md", "w", encoding="utf-8") as f:
        f.write(report)

    print(f"\n\n{'='*70}")
    print(f"–¢–ï–°–¢ –ó–ê–í–ï–†–®–Å–ù. –û—Ç—á—ë—Ç: TEST_RF_INTERNAL_REPORT.md")
    cards_ok = sum(1 for r in results if r["got_cards"])
    fp_count = sum(1 for r in results for c in r["consult"] if c["false_promise"])
    print(f"–ö–∞—Ä—Ç–æ—á–∫–∏: {cards_ok}/{len(results)} | –õ–æ–∂–Ω—ã–µ –æ–±–µ—â–∞–Ω–∏—è: {fp_count}")
    print(f"{'='*70}")
